# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π shrkga_microservices
–û–ø–∏—Å–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π.

## –î–ó #21. Ingress-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –∏ —Å–µ—Ä–≤–∏—Å—ã –≤ Kubernetes

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –ò–∑—É—á–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–ª–∞–≥–∏–Ω–∞ `kube-dns` –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–æ–≤ `kube-dns-autoscaler` –∏ `coredns`;
- –°–æ–∑–¥–∞–Ω `LoadBalancer` –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ `UI`, –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞–ª –ø–æ `http`;
- –ó–∞–ø—É—â–µ–Ω `Ingress Controller` –Ω–∞ –±–∞–∑–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞ `Nginx` (–≤–µ—Ä—Å–∏—è –∏–∑ –î–ó –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∞, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤–µ—Ä—Å–∏—è `v1.8.2`);
```
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml
```
- –°–æ–∑–¥–∞–Ω `Single Service Ingress` –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ `UI`, –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞–ª –ø–æ `http`;
- –°—Ç–∞—Ä—ã–π –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ `LoadBalancer` —É–¥–∞–ª–µ–Ω;
- –°–æ–∑–¥–∞–Ω TLS —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç, –Ω–∞ –µ–≥–æ –æ—Å–Ω–æ–≤–µ —Å–æ–∑–¥–∞–Ω `Secret`;
- Ingress –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –ø—Ä–∏–µ–º —Ç–æ–ª—å–∫–æ HTTPS —Ç—Ä–∞—Ñ–∏–∫–∞;
- –î–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–∞–±–æ—Ç–∞–ª –ø–æ `https`;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –û–ø–∏—à–∏—Ç–µ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç Secret –≤ –≤–∏–¥–µ Kubernetes-–º–∞–Ω–∏—Ñ–µ—Å—Ç–∞
- Secret –æ–ø–∏—Å–∞–Ω –≤ —Ñ–∞–π–ª–µ [`kubernetes/reddit/ui-secret.yml`](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/blob/kubernetes-3/kubernetes/reddit/ui-secret.yml);

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ)
- –°–æ–∑–¥–∞–Ω –æ–±—ä–µ–∫—Ç `NetworkPolicy` –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ `mongo`;
- –î–æ—Å—Ç—É–ø –∫ –ø–æ–¥–∞–º —Å MongoDB —Ä–∞–∑—Ä–µ—à–µ–Ω –æ—Ç –ø–æ–¥–æ–≤ —Å label'–∞–º–∏ `comment` –∏ `post`;
- –ò–∑—É—á–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª `PersitentVolume` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö MongoDB;
- –í Yandex Cloud —Å–æ–∑–¥–∞–Ω –¥–∏—Å–∫;
- –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç —Ç–∏–ø–∞ `PersitentVolume` –¥–ª—è —Ä–µ—Å—É—Ä—Å–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –≤ Yandex Cloud;
- –°–æ–∑–¥–∞–Ω –º–∞–Ω–∏—Ñ–µ—Å—Ç —Ç–∏–ø–∞ `PersistentVolumeClaim` –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –≤—ã–¥–∞—á—É –º–µ—Å—Ç–∞ –∏–∑ `PersitentVolume`;
- –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π –¥–∏—Å–∫ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –∫ –ø–æ–¥—É mongo;
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ —Å –ø–æ—Å–ª–µ–¥—É—é—â–∏–º —É–¥–∞–ª–µ–Ω–∏–µ–º –∏ —Å–æ–∑–¥–∞–Ω–∏–µ–º –¥–µ–ø–ª–æ—è mongo. –ü–æ—Å—Ç –æ—Å—Ç–∞–ª—Å—è –Ω–∞ –º–µ—Å—Ç–µ.

## –î–ó #20. –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –≤ Kubernetes

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ú–æ–¥–µ–ª—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ö–æ—Å—Ç–æ–≤–∞—è –º–∞—à–∏–Ω–∞ –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º Ubuntu 22.04.3;
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Ç–∏–ª–∏—Ç–∞ `kubectl`;
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã —É—Ç–∏–ª–∏—Ç—ã `minikube`;
- –£—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω Minikube-–∫–ª–∞—Å—Ç–µ—Ä;
- –ò–∑—É—á–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç –∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `~/.kube/config`;
- –°–æ–∑–¥–∞–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã —Å—É—â–Ω–æ—Å—Ç–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Reddit –≤ –∫–∞—Ç–∞–ª–æ–≥–µ [`kubernetes/reddit`](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/blob/kubernetes-2/kubernetes/reddit);
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã –≤ `minicube`;
```
$ kubectl apply -f ./kubernetes/reddit/
```
- –î–ª—è —Å–≤—è–∑–∏ `ui` —Å `post` –∏ `comment` —Å–æ–∑–¥–∞–Ω—ã –æ–±—ä–µ–∫—Ç—ã —Ç–∏–ø–∞ `Service`;
- –î–ª—è —Å–≤—è–∑–∏ `post` –∏ `comment` —Å `mongodb` –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –∏–º–µ–Ω `post-db` –∏ `comment-db`, —Å–æ–∑–¥–∞–Ω—ã —Å–µ—Ä–≤–∏—Å—ã —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∏–º–µ–Ω–∞–º–∏;
- –í –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞—Ö –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç–æ–≤ `post` –∏ `comment` –∑–∞–¥–∞–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Ö–æ—Å—Ç –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ë–î) –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MongoDB;
- –°–æ–∑–¥–∞–Ω Service –¥–ª—è UI-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –∏–∑–≤–Ω–µ;
- –ü–æ–¥–∫–ª—é—á–µ–Ω –∞–¥–¥–æ–Ω Minikube `dashboard`;
```
minikube addons enable dashboard
minikube dashboard --url
```
- Dashboard —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã–ª—Å—è http://127.0.0.1:43723/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/
- –ò–∑—É—á–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Namespaces;
- –°–æ–∑–¥–∞–Ω–æ –æ–∫—Ä—É–∂–µ–Ω–∏–µ `dev`, –≤ –Ω—ë–º –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ;
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ UI;

#### Yandex Cloud Managed Service for Kubernetes
- –°–æ–∑–¥–∞–Ω Kubernetes –∫–ª–∞—Å—Ç–µ—Ä –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º `test-cluster` —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–æ–Ω—Å–æ–ª–∏ Yandex Cloud;
- –°–æ–∑–¥–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ –∏–∑ –¥–≤—É—Ö —É–∑–ª–æ–≤, –≤—Ö–æ–¥—è—â–∏—Ö –≤ –∫–ª–∞—Å—Ç–µ—Ä;
- –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É;
```
yc managed-kubernetes cluster get-credentials test-cluster --external
```
- –í `test-cluster` —Å–æ–∑–¥–∞–Ω–æ `dev` namespace, –∫—É–¥–∞ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è `reddit`;
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É –æ–¥–Ω–æ–π –∏–∑ –Ω–æ–¥ –≤ `test-cluster`;

> [>>> –°–∫—Ä–∏–Ω—à–æ—Ç—ã –∑–¥–µ—Å—å <<<](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/blob/kubernetes-2/kubernetes/screenshots)

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ Yandex Cloud —Å –ø–æ–º–æ—â—å—é Terraform –º–æ–¥—É–ª—è
- –í –∫–∞—Ç–∞–ª–æ–≥–µ [`kubernetes/terraform-k8s`](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/blob/kubernetes-2/kubernetes/terraform-k8s) –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Terraform –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤ `yandex_kubernetes_cluster` –∏ `yandex_kubernetes_node_group`;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –°–æ–∑–¥–∞–Ω–∏–µ YAML-–º–∞–Ω–∏—Ñ–µ—Å—Ç–æ–≤ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è dashboard
- Dashboard UI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –µ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ;
```
kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml
```
- –í –∫–∞—Ç–∞–ª–æ–≥–µ [`kubernetes/dashboard`](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/blob/kubernetes-2/kubernetes/dashboard) –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–µ–π `ServiceAccount` –∏ `ClusterRoleBinding` –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Dashboard UI;
```
kubectl apply -f ./kubernetes/dashboard/
```
- –ü–æ–ª—É—á–µ–Ω `Bearer Token` –¥–ª—è `ServiceAccount`;
```
kubectl -n kubernetes-dashboard create token admin-user
```
- –ó–∞–ø—É—â–µ–Ω `kubectl proxy`;
- Dashboard UI –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ URL http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/
> [–°–∫—Ä–∏–Ω—à–æ—Ç Dashboard UI](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/raw/kubernetes-2/kubernetes/screenshots/chrome_wHpxVZf0L9.png?raw=true)

## –î–ó #19. –í–≤–µ–¥–µ–Ω–∏–µ –≤ Kubernetes

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –û–ø–∏—Å–∞–Ω—ã Deployment –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π `comment`, `mongo`, `post`, `ui`;
- –í YC —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã –¥–≤–µ –í–ú –¥–ª—è master –∏ worker –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes;
- –° –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥ `kubeadm init` –∏ `kubeadm join` —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª–∞—Å—Ç–µ—Ä k8s;
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å–µ—Ç–µ–≤–æ–π –ø–ª–∞–≥–∏–Ω `Calico`;
```
wget https://projectcalico.docs.tigera.io/manifests/calico.yaml
sed -i -r -e 's/^(\s*)#\s*(- name: CALICO_IPV4POOL_CIDR)\s*$/\1\2\n\1  value: "10.244.0.0\/16"/g' calico.yaml
kubectl apply -f calico.yaml
```
- –ö–ª–∞—Å—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã `kubectl apply -f manifest.yaml` –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã –ø–æ–¥—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π `comment`, `mongo`, `post`, `ui`;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞ k8s —Å –ø–æ–º–æ—â—å—é terraform –∏ ansible
- –í –ø–∞–ø–∫–µ `kubernetes/terraform` –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Terraform –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ master –∏ worker –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes;
- –í –ø–∞–ø–∫–µ `kubernetes/ansible` –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Ansible –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ k8s —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –Ω–æ–¥–∞–º master –∏ worker —Ä–æ–ª–µ–π;
- –î–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ö–æ—Å—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω—ã (—Å–∫–æ–ø–∏–ø–∞—â–µ–Ω—ã) —Ç–∞—Å–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Å–≤–æ–ø–∞, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ `sysctl` –¥–ª—è k8s, –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è —è–¥—Ä–∞ `br_netfilter`, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `iptables`;
- –í –ø–ª–µ–π–±—É–∫–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ä–æ–ª–∏ Ansible `geerlingguy.containerd` –∏ `geerlingguy.kubernetes`, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∏–∑ Ansible-galaxy;
- –î–ª—è —Å–µ—Ç–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–ª–∞–≥–∏–Ω `Calico`;
- –ü–æ—Å–ª–µ –æ—Ç—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã `ansible-playbook -i inventory.yml playbooks/k8s.yml` –∫–ª–∞—Å—Ç–µ—Ä —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è;
```
$ ssh ubuntu@51.250.70.117 sudo kubectl get nodes
NAME           STATUS   ROLES           AGE     VERSION
k8s-master-0   Ready    control-plane   3m26s   v1.28.2
k8s-worker-1   Ready    <none>          3m4s    v1.28.2

$ ssh ubuntu@51.250.70.117 sudo kubectl get pods --all-namespaces -o wide
NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE     IP            NODE           NOMINATED NODE   READINESS GATES
kube-system   calico-kube-controllers-7ddc4f45bc-rtpm5   1/1     Running   0          3m21s   10.244.72.3   k8s-master-0   <none>           <none>
kube-system   calico-node-4h49c                          1/1     Running   0          3m16s   10.128.0.10   k8s-worker-1   <none>           <none>
kube-system   calico-node-6b9kp                          1/1     Running   0          3m21s   10.128.0.32   k8s-master-0   <none>           <none>
kube-system   coredns-5dd5756b68-692q4                   1/1     Running   0          3m21s   10.244.72.1   k8s-master-0   <none>           <none>
kube-system   coredns-5dd5756b68-lbs9n                   1/1     Running   0          3m21s   10.244.72.2   k8s-master-0   <none>           <none>
kube-system   etcd-k8s-master-0                          1/1     Running   0          3m34s   10.128.0.32   k8s-master-0   <none>           <none>
kube-system   kube-apiserver-k8s-master-0                1/1     Running   0          3m34s   10.128.0.32   k8s-master-0   <none>           <none>
kube-system   kube-controller-manager-k8s-master-0       1/1     Running   0          3m36s   10.128.0.32   k8s-master-0   <none>           <none>
kube-system   kube-proxy-2pbdg                           1/1     Running   0          3m21s   10.128.0.32   k8s-master-0   <none>           <none>
kube-system   kube-proxy-hd7dd                           1/1     Running   0          3m16s   10.128.0.10   k8s-worker-1   <none>           <none>
```
- –ó–∞–¥–µ–ø–ª–æ–µ–Ω—ã –ø–æ–¥—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π `comment`, `mongo`, `post`, `ui`, –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç.

```
# kubectl get pods -o wide
NAME                                  READY   STATUS    RESTARTS   AGE     IP             NODE           NOMINATED NODE   READINESS GATES
comment-deployment-687bccf5fd-hzs5h   1/1     Running   0          2m17s   10.244.230.2   k8s-worker-1   <none>           <none>
mongo-deployment-79d69f4666-l6pnm     1/1     Running   0          2m43s   10.244.230.1   k8s-worker-1   <none>           <none>
post-deployment-68db465f9c-84dwr      1/1     Running   0          2m12s   10.244.230.3   k8s-worker-1   <none>           <none>
ui-deployment-7d84b9f894-8k4dk        1/1     Running   0          2m8s    10.244.230.4   k8s-worker-1   <none>           <none>
```

## –î–ó #18. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ Docker

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞
- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
  - –°–∫–∞—á–∞–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ç–∫–∞ reddit;
  - –í—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å–±–æ—Ä–∫–∞ logging-enabled –æ–±—Ä–∞–∑–æ–≤ —Å —Ç—ç–≥–∞–º–∏ `logging`;
  - –í YC —Å–æ–∑–¥–∞–Ω–∞ docker-machine;
- –°–æ–∑–¥–∞–Ω compose-—Ñ–∞–π–ª –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è ElasticSearch + Fluentd + Kibana;
- –°–æ–∑–¥–∞–Ω—ã Dockerfile –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Fluentd, –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞;

#### C–±–æ—Ä –ª–æ–≥–æ–≤, –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
- –ò–∑—É—á–µ–Ω —Å–±–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–µ—Ä–≤–∏—Å–∞ `post`;
- –ò–∑—É—á–µ–Ω —Å–±–æ—Ä –Ω–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–µ—Ä–≤–∏—Å–∞ `ui`;
- –ò–∑—É—á–µ–Ω—ã Grok-—à–∞–±–ª–æ–Ω—ã;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –†–∞–∑–±–æ—Ä –µ—â—ë –æ–¥–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–≥–æ–≤
- –°–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Fluentd –¥–ª—è —Ä–∞–∑–±–æ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –ª–æ–≥–æ–≤ UI-—Å–µ—Ä–≤–∏—Å–∞ —Å `path`, `remote_addr`, `method`, `response_status`;
```
$ cat logging/fluentd/fluent.conf

...
<filter service.ui>
  @type parser
  <parse>
    @type grok
    <grok>
      pattern service=%{WORD:service} \| event=%{WORD:event} \| path=%{GREEDYDATA:path} \| request_id=%{GREEDYDATA:request_id} \| remote_addr=%{IPV4:remote_addr} \| method= %{WORD:method} \| response_status=%{INT:response_status}
    </grok>
  </parse>
  key_name message
  # reserve_data true
</filter>
...
```

#### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —Ç—Ä–µ–π—Å–∏–Ω–≥
- –í compose-—Ñ–∞–π–ª –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω —Å–µ—Ä–≤–∏—Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Ç—Ä–µ–π—Å–∏–Ω–≥–∞ Zipkin;
- –°–µ—Ä–≤–∏—Å—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Zipkin;
- –ò–∑—É—á–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ç—Ä–µ–π—Å–æ–≤ —á–µ—Ä–µ–∑ web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Zipkin;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –¢—Ä–∞–±–ª—à—É—Ç–∏–Ω–≥ UI-—ç–∫—Å–ø–∏—Ä–∏–µ–Ω—Å–∞
- –ó–∞–≥—Ä—É–∂–µ–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å–æ —Å–ª–æ–º–∞–Ω–Ω—ã–º –∫–æ–¥–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ –∫–∞—Ç–∞–ª–æ–≥ `src-bugged`;
- –í –ø—Ä–æ—Ü–µ—Å—Å–µ –±–∏–ª–¥–∞ –±–∞–≥–Ω—É—Ç–æ–≥–æ –∫–æ–¥–∞ —Å–Ω–æ–≤–∞ –ø–æ—Å—ã–ø–∞–ª–∏—Å—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ–º, —á—Ç–æ –≤—Å–µ —É—Å—Ç–∞—Ä–µ–ª–æ –∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è üò°
- –ü–æ—ç—Ç–æ–º—É –±—É–¥—É –∫—Ä–∞—Ç–æ–∫: —Ç–æ—Ä–º–æ–∑–∞ –ø—Ä–∏ –ø–æ—Å—Ç–µ –∏–∑-–∑–∞ —Ç–æ–≥–æ, —á—Ç–æ –≤ –±–∞–≥–Ω—É—Ç–æ–º –∫–æ–¥–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–º–∞–Ω–¥–∞ `time.sleep(3)`;
```
$ cat src-bugged/post-py/post_app.py

...
    else:
        stop_time = time.time()  # + 0.3
        resp_time = stop_time - start_time
        app.post_read_db_seconds.observe(resp_time)

        time.sleep(3) # <<<<<<<<<<<<<<< BUG <<<<<<<<<<<<<<<

        log_event('info', 'post_find',
                  'Successfully found the post information',
                  {'post_id': id})
        return dumps(post)
...
```

## –î–ó #17. –í–≤–µ–¥–µ–Ω–∏–µ –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥. –ú–æ–¥–µ–ª–∏ –∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω Docker —Ö–æ—Å—Ç –≤ Yandex Cloud, –ª–æ–∫–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –Ω–∞ —Ä–∞–±–æ—Ç—É —Å –Ω–∏–º;
- Prometheus –∑–∞–ø—É—â–µ–Ω –∏–∑ –æ–±—Ä–∞–∑–∞ `prom/prometheus`;
- –ò–∑—É—á–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é;
- –ò–∑—É—á–µ–Ω —Ä–∞–∑–¥–µ–ª Targets (—Ü–µ–ª–∏) –∏ —Ñ–æ—Ä–º–∞—Ç —Å–æ–±–∏—Ä–∞–µ–º—ã—Ö –º–µ—Ç—Ä–∏–∫, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø–æ –∞–¥—Ä–µ—Å—É `host:port/metrics`;
- –°–æ–∑–¥–∞–Ω –∫–∞—Å—Ç–æ–º–Ω—ã–π Docker –æ–±—Ä–∞–∑ Prometheus –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `prometheus.yml`;
- –°–æ–∑–¥–∞–Ω `docker-compose.yml` —Ñ–∞–π–ª –¥–ª—è –ø–æ–¥–Ω—è—Ç–∏—è Prometheus —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ `ui`, `post`, `comment`, `mongo_db`;
- –ò–∑—É—á–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Prometheus –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–æ–≤—ã—Ö —Ü–µ–ª–µ–π –∏ Endpoint'–æ–≤ –Ω–∞—à–∏—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤;
- –î–æ–±–∞–≤–ª–µ–Ω —Å–±–æ—Ä –º–µ—Ç—Ä–∏–∫ Docker —Ö–æ—Å—Ç–∞ –ø—Ä–∏ –ø–æ–º–æ—â–∏ Node exporter:
  - –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –≤ `docker-compose.yml`;
  - –î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π Job –≤ `prometheus.yml`;
- –ò–∑—É—á–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ —Ö–æ—Å—Ç–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –ø—Ä–∏ –ø–æ–≤—ã—à–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ CPU

#### –°–æ–±—Ä–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã –∑–∞–ø—É—à–µ–Ω—ã –Ω–∞ DockerHub
> https://hub.docker.com/u/shrkga

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ MongoDB –≤ Prometheus
- –í Prometheus –¥–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ MongoDB —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞ `percona/mongodb_exporter`;
```
$ cat docker/docker-compose.yml
...
  mongodb_exporter:
    image: percona/mongodb_exporter:0.40
    command:
      - '--mongodb.uri=mongodb://mongo_db:27017'
      - '--compatible-mode'
      - '--mongodb.direct-connect=true'
    # ports:
    #   - 9216:9216/tcp
    networks:
      - back_net
      - front_net
    depends_on:
      - mongo_db
...
```
```
$ cat monitoring/prometheus/prometheus.yml
...
  - job_name: 'mongodb'
    static_configs:
    - targets:
      - 'mongodb_exporter:9216'
...
```

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–æ–≤ comment, post, ui –≤ Prometheus —Å –ø–æ–º–æ—â—å—é Blackbox exporter
- –í Prometheus –¥–æ–±–∞–≤–ª–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–æ–≤ comment, post, ui —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä–∞ `prom/blackbox-exporter`;
- –°–æ–±—Ä–∞–Ω –∏ –∑–∞–ø—É—à–µ–Ω –Ω–∞ DockerHub –∫–∞—Å—Ç–æ–º–Ω—ã–π –æ–±—Ä–∞–∑ —Å –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `config.yml`;
```
$ cat monitoring/blackbox/Dockerfile

FROM prom/blackbox-exporter:latest
ADD config.yml /etc/blackbox_exporter/
```
```
$ cat monitoring/blackbox/config.yml

modules:
  http_2xx:
    prober: http
    timeout: 5s
    http:
      valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
      valid_status_codes: []
      method: GET
      follow_redirects: false
```
```
$ cat docker/docker-compose.yml
...
  blackbox-exporter:
    image: ${USERNAME}/blackbox-exporter
    # ports:
    #   - 9115:9115/tcp
    networks:
      - front_net
    depends_on:
      - ui
      - post
      - comment
...
```
```
$ cat monitoring/prometheus/prometheus.yml
...
  - job_name: 'blackbox'
    metrics_path: /metrics
    params:
      module: [http_2xx]
    static_configs:
      - targets:
        - http://ui:9292
        - http://comment:9292
        - http://post:9292
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
...
```

–ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

![Prometheus Targets](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/blob/monitoring-1/monitoring/img/prom.png?raw=true)

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ–º–æ—â–∏ `Makefile`
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å—Ü–µ–Ω–∞—Ä–∏–∏ –±–∏–ª–¥–∞ –∏ –ø—É—à–∞ –≤ DockerHub –ª—é–±–æ–≥–æ, –∏–ª–∏ –≤—Å–µ—Ö —Å—Ä–∞–∑—É, –æ–±—Ä–∞–∑–æ–≤;
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ `make help`, –ª–∏–±–æ –ø—Ä–æ—Å—Ç–æ `make` –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤.
```
$ cd monitoring/
$ make help

build-all        Build all images
build-blackbox   Build Blackbox exporter image
build-comment    Build Comment image
build-post       Build Post image
build-prometheus Build Prometheus exporter image
build-ui         Build UI image
help             Display this help screen
push-all         Push all images to Docker Hub
push-blackbox    Push Blackbox exporter image to Docker Hub
push-comment     Push Comment image to Docker Hub
push-post        Push Post image to Docker Hub
push-prometheus  Push Prometheus image to Docker Hub
push-ui          Push UI image to Docker Hub
```
> **[Makefile –∑–¥–µ—Å—å](https://github.com/Otus-DevOps-2023-07/shrkga_microservices/blob/monitoring-1/monitoring/Makefile)**


## –î–ó #16. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ Gitlab CI. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –û–±–ª–∞—á–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–ø–∏—Å–∞–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–¥—Ö–æ–¥–∞ IaC;
- –í –ø–∞–ø–∫–µ `gitlab-ci/infra/terraform` –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Terraform –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –í–ú –≤ YC;
- –í –ø–∞–ø–∫–µ `gitlab-ci/infra/ansible` –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Ansible –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ –í–ú `Docker`, `GitLab CE` –∏ `GitLab Runner`:
  - `playbooks/docker.yml` -- –ø–ª–µ–π–±—É–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–∫–µ—Ä–∞;
  - `playbooks/gitlab-ce.yml` -- –ø–ª–µ–π–±—É–∫ –¥–ª—è omnibus-—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–∏—Ç–ª–∞–±–∞;
  - `playbooks/gitlab-runner.yml` -- –ø–µ–ª–π–±—É–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥–∏—Ç–ª–∞–± —Ä–∞–Ω–Ω–µ—Ä–∞;
  - `playbooks/site.yml` -- –ø–ª–µ–π–±—É–∫ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤;
- –í —Ñ–∞–π–ª–µ `gitlab-ci/docker-compose.yml` –æ–ø–∏—Å–∞–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ gitlab-ce —á–µ—Ä–µ–∑ `docker compose`;
- –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ `docker compose up -d` –æ—Ç—Ä–∞–±–æ—Ç–∞–ª —É—Å–ø–µ—à–Ω–æ, GitLab –ø–æ–¥–Ω—è–ª—Å—è –ø–æ –∞–¥—Ä–µ—Å—É http://yc-vm-ip/;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è GitLab
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è GitLab —Å –ø–æ–º–æ—â—å—é –º–æ–¥—É–ª—è Ansible `docker_container` (—Å–º. –ø–ª–µ–π–±—É–∫ `gitlab-ci/infra/ansible/playbooks/gitlab-ce.yml`);

#### –ü—Ä–æ–µ–∫—Ç –≤ GitLab
- –í GitLab —Å–æ–∑–¥–∞–Ω—ã –≥—Ä—É–ø–ø–∞ `homework` –∏ –ø—Ä–æ–µ–∫—Ç `example`;
- –í —Ñ–∞–π–ª–µ `.gitlab-ci.yml` –æ–ø–∏—Å–∞–Ω CI/CD Pipeline;
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω GitLab Runner;
- –ü–∞–π–ø–ª–∞–π–Ω —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–∞–±–æ—Ç–∞–ª;
- –¢–µ—Å—Ç—ã –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –î–ó;
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è `dev`, `beta` –∏ `production`;
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –æ–∫—Ä—É–∂–µ–Ω–∏—è `stage` –∏ `production` –¥–ª—è –≤—ã–∫–∞—Ç—ã–≤–∞–Ω–∏—è –∫–æ–¥–∞ —Å —è–≤–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π (–ø–æ–º–µ—á–µ–Ω–Ω–æ–≥–æ —Å –ø–æ–º–æ—â—å—é —Ç—ç–≥–∞ –≤ git);
- –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –≤–µ—Ç–∫–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, –∫—Ä–æ–º–µ –≤–µ—Ç–∫–∏ master;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –ó–∞–ø—É—Å–∫ reddit –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
- –í —ç—Ç–∞–ø –ø–∞–π–ø–ª–∞–π–Ω–∞ `build` –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º `reddit`;
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å reddit –¥–µ–ø–ª–æ–∏—Ç—Å—è –Ω–∞ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–µ –¥–ª—è –∫–∞–∂–¥–æ–π –≤–µ—Ç–∫–∏ –≤ GitLab;

```
build_job:
  stage: build
  image: docker:latest
  environment:
    name: branch/${CI_COMMIT_REF_NAME}
  script:
    - echo 'Building'
    - docker build -t reddit:${CI_ENVIRONMENT_SLUG} docker-monolith/
    - docker rm -f reddit-${CI_ENVIRONMENT_SLUG}
    - docker run --name reddit-${CI_ENVIRONMENT_SLUG} --publish-all --detach reddit:${CI_ENVIRONMENT_SLUG}
    - REDDIT_PORT=$(docker port reddit-${CI_ENVIRONMENT_SLUG} 9292/tcp | head -n 1 | awk -F ':' '{print $2}')
    - echo "Application URL -- http://${CI_SERVER_HOST}:${REDDIT_PORT}/"
```

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê. –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è GitLab Runner
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è GitLab Runner —Å –ø–æ–º–æ—â—å—é –º–æ–¥—É–ª—è Ansible `docker_container` (—Å–º. –ø–ª–µ–π–±—É–∫ `gitlab-ci/infra/ansible/playbooks/gitlab-runner.yml`);

### –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ `terraform` –∏ `ansible`

```
$ cd gitlab-ci/infra/terraform/
$ terraform apply -auto-approve=true

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create
  ...

Apply complete! Resources: 1 added, 0 changed, 0 destroyed.

Outputs:

external_ip_address_docker = [
  "51.250.7.91",
]
```

```
$ cd ../ansible/
$ ansible-playbook playbooks/site.yml

PLAY [Install Docker] *****************************************************************

TASK [Gathering Facts] ****************************************************************
ok: [51.250.7.91]

TASK [Add Docker GPG apt Key] *********************************************************
changed: [51.250.7.91]

TASK [Add Docker Repository] **********************************************************
changed: [51.250.7.91]

TASK [Update apt and install packages] ************************************************
changed: [51.250.7.91]

TASK [Install Docker Module for Python] ***********************************************
changed: [51.250.7.91]

PLAY [Install GitLab CE] **************************************************************

TASK [Gathering Facts] ****************************************************************
ok: [51.250.7.91]

TASK [Create gitlab-ce container] *****************************************************
changed: [51.250.7.91]

PLAY [Install GitLab Runner] **********************************************************

TASK [Gathering Facts] ****************************************************************
ok: [51.250.7.91]

TASK [Create gitlab-runner container] *************************************************
changed: [51.250.7.91]

PLAY RECAP ****************************************************************************
51.250.7.91 : ok=9  changed=6  unreachable=0  failed=0  skipped=0  rescued=0  ignored=0
```

```
$ ssh ubuntu@51.250.7.91 sudo docker ps -a
CONTAINER ID   IMAGE                         COMMAND                  CREATED         STATUS                   PORTS                                                            NAMES
07eca80677fb   gitlab/gitlab-runner:latest   "/usr/bin/dumb-init ‚Ä¶"   5 minutes ago   Up 5 minutes                                                                              gitlab-runner
6ee1bedadbce   gitlab/gitlab-ce:latest       "/assets/wrapper"        5 minutes ago   Up 5 minutes (healthy)   0.0.0.0:80->80/tcp, 0.0.0.0:443->443/tcp, 0.0.0.0:2222->22/tcp   gitlab-ce
```

## –î–ó #15. –°–µ—Ç–µ–≤–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤. Docker Compose. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤

–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –ò–∑—É—á–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Å–µ—Ç–µ–≤—ã–º–∏ –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ `none`, `host`, `bridge`;
- –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã `ifconfig` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ —Å–µ—Ç–µ–≤–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ docker-—Ö–æ—Å—Ç–∞:
  - –ö–æ–º–∞–Ω–¥–∞ –≤—ã–≤–æ–¥–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω—ã, —Ç.–∫. –≤ —Å–ª—É—á–∞–µ –¥—Ä–∞–π–≤–µ—Ä–∞ `host` —É—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —Å–µ—Ç–µ–≤–∞—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –∏ —Ö–æ—Å—Ç–æ–º docker –∏ –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–µ—Ç–µ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã —Ö–æ—Å—Ç–∞;
- –ü—Ä–æ–≤–µ–¥–µ–Ω —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `nginx` —Å —Å–µ—Ç—å—é `host`:
  - `docker ps` –≤—ã–≤–µ–ª –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ —Å–º–æ–≥–ª–∏ —Å–¥–µ–ª–∞—Ç—å bind –Ω–∞ 80 –ø–æ—Ä—Ç, —Ç.–∫. –µ–≥–æ –∑–∞–Ω—è–ª –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä. –û—Å—Ç–∞–ª—å–Ω—ã–µ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤—ã–¥–∞–ª–∏ –æ—à–∏–±–∫—É:
```
nginx: [emerg] bind() to [::]:80 failed (98: Address already in use)
```
- –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ net-namespaces –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏ `none` –∏ `host`;
- –ò–∑—É—á–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Å–µ—Ç–µ–≤—ã—Ö –∞–ª–∏–∞—Å–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–∞ reddit —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º bridge-—Å–µ—Ç–∏;
- –ò–∑—É—á–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ç—è—Ö;
- –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–µ—Ç–µ–≤–æ–≥–æ —Å—Ç–µ–∫–∞ Linux –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å `bridge` —Å–µ—Ç—è–º–∏;
- –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ `iptables` –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å `bridge` —Å–µ—Ç—è–º–∏;

#### –†–∞–±–æ—Ç–∞ —Å Docker-compose
- –ü—Ä–æ–µ–∫—Ç reddit –æ–ø–∏—Å–∞–Ω –≤ —Ñ–∞–π–ª–µ `docker-compose.yml`;
- –§–∞–π–ª –∏–∑–º–µ–Ω–µ–Ω –ø–æ–¥ –∫–µ–π—Å —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–µ—Ç–µ–π, —Å–µ—Ç–µ–≤—ã—Ö –∞–ª–∏–∞—Å–æ–≤;
- `docker-compose.yml` –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –ø–æ–º–æ—â—å—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –æ–ø–∏—Å–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ `.env`:
```
COMPOSE_PROJECT_NAME=reddit
UI_PORT=9292
DB_TAG=4
UI_TAG=3.0
COMMENT_TAG=2.0
POST_TAG=1.0
DB_PATH=/data/db/
USERNAME=shrkga
```
- –ë–∞–∑–æ–≤–æ–µ –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–æ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `COMPOSE_PROJECT_NAME=reddit`;
- –°–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `docker-compose.override.yml` —Å —Ü–µ–ª—å—é –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ `command` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ `comment` –∏ `ui`, –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–Ω–∏—è –ø–∞–ø–∫–∏ —Å –∫–æ–¥–æ–º —Å —Ö–æ—Å—Ç–∞ –≤–Ω—É—Ç—Ä—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:
```
version: '3.3'
services:

  ui:
    volumes:
      - ./ui/:/app/
    command: ["puma", "--debug", "-w", "2"]

  comment:
    volumes:
      - ./comment/:/app/
    command: ["puma", "--debug", "-w", "2"]

  post:
    volumes:
      - ./post-py/:/app/
```

## –î–ó #14. Docker –æ–±—Ä–∞–∑—ã. –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã
–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω—ã `Dockerfile` –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ `post-py`, `comment`, `ui`;
- –°–æ–±—Ä–∞–Ω—ã –æ–±—Ä–∞–∑—ã –¥–ª—è –≤—Å–µ—Ö —Ç—Ä–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ —Å —Ç—ç–≥–æ–º `1.0`;
- –°–±–æ—Ä–∫–∞ `ui` –Ω–∞—á–∞–ª–∞—Å—å –Ω–µ —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞ –ø–æ —Ç–æ–π –ø—Ä–∏—á–∏–Ω–µ, —á—Ç–æ –Ω–∞—á–∞–ª—å–Ω—ã–µ —à–∞–≥–∏ —Å–±–æ—Ä–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã —Å–µ—Ä–≤–∏—Å—É `comment`, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Ä–∞–Ω–µ–µ –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –∏ –±—ã–ª–∏ –∑–∞–∫—ç—à–∏—Ä–æ–≤–∞–Ω—ã –¥–æ–∫–µ—Ä–æ–º:
- –°–æ–∑–¥–∞–Ω–∞ bridge-—Å–µ—Ç—å –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º `reddit`;
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—à–µ–Ω—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å–µ—Ç–µ–≤—ã—Ö –∞–ª–∏–∞—Å–æ–≤;
- –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É `http://<docker-host-ip>:9292/`;
- –¢.–∫. —Ä–∞–±–æ—Ç–∞–µ–º —Å –Ω–∞—Å—Ç–æ–ª—å–∫–æ –¥—Ä–µ–≤–Ω–∏–º –∫–æ–¥–æ–º, —á—Ç–æ —É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω—É–∂–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤, —Ç–æ –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ ruby:2.2 –ø—Ä–∏—à–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∞—Ä—Ö–∏–≤–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `deb http://archive.debian.org/debian stretch main`:
```
FROM ruby:2.2

RUN set -x \
 && echo "deb http://archive.debian.org/debian stretch main" > /etc/apt/sources.list \
 && apt-get update -qq \
 && apt-get install -y build-essential \
 && apt-get clean
```

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê
- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã —Å –¥—Ä—É–≥–∏–º–∏ —Å–µ—Ç–µ–≤—ã–º–∏ –∞–ª–∏–∞—Å–∞–º–∏;
- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ —ç—Ç–æ–º –∑–∞–¥–∞–Ω—ã —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä `--env` –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–∞:
```
docker run -d --network=reddit \
  --network-alias=post_db_star --network-alias=comment_db_star \
  mongo:4

docker run -d --network=reddit \
  --network-alias=post_star \
  --env POST_DATABASE_HOST=post_db_star \
  shrkga/post:1.0

docker run -d --network=reddit \
  --network-alias=comment_star \
  --env POST_DATABASE_HOST=comment_db_star \
  shrkga/comment:1.0

docker run -d --network=reddit -p 9292:9292 \
  --env POST_SERVICE_HOST=post_star \
  --env COMMENT_SERVICE_HOST=comment_star \
  shrkga/ui:1.0
```

#### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–∑–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –°–µ—Ä–≤–∏—Å `ui` –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å —Ç—ç–≥–æ–º `2.0` –Ω–∞ –±–∞–∑–µ `ubuntu:16.04`;
- –°–±–æ—Ä–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å —Å –ø–µ—Ä–≤–æ–≥–æ —à–∞–≥–∞, –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –Ω–µ—Ç;
- –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ 2.0 —Å–æ—Å—Ç–∞–≤–∏–ª 487MB, –≤ –æ—Ç–ª–∏—á–∏–∏ –æ—Ç 1.0, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª 998MB;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê: —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ Alpine Linux
- –°–µ—Ä–≤–∏—Å `ui` –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å —Ç—ç–≥–æ–º `3.0` –Ω–∞ –±–∞–∑–µ `alpine:3.14` (–∫—Ä–∞–π–Ω–∏–π –æ–±—Ä–∞–∑, –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö –∫–æ—Ç–æ—Ä–æ–≥–æ –µ—Å—Ç—å ruby –≤–µ—Ä—Å–∏–∏ 2);
- –í—ã–ø–æ–ª–Ω–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å —Ü–µ–ª—å—é —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–ª–æ–µ–≤ UnionFS –∏ —É–¥–∞–ª–µ–Ω–∏—è –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±—Ä–∞–∑–∞:
```
# shrkga/ui:3.0

FROM alpine:3.14

WORKDIR /app
COPY Gemfile* ./

RUN set -x \
 && apk --no-cache --update add ruby-full ruby-dev build-base \
 && gem install bundler:1.17.2 --no-document \
 && bundle install \
 && apk del ruby-dev build-base

COPY . ./
ENV POST_SERVICE_HOST=post POST_SERVICE_PORT=5000 COMMENT_SERVICE_HOST=comment COMMENT_SERVICE_PORT=9292
EXPOSE 9292/tcp

CMD ["puma"]
```
- –°–µ—Ä–≤–∏—Å `comment` –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å —Ç—ç–≥–æ–º `2.0` –Ω–∞ –±–∞–∑–µ `alpine:3.14`, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Å–º. `src/comment/Dockerfile`);
- –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–∞ `post` –Ω–∞ –±–∞–∑–µ `alpine:3.9` –Ω–µ –ø—Ä–∏–Ω–µ—Å–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏ –æ–±—Ä–∞–∑ —Å—Ç–∞–ª –¥–∞–∂–µ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª—å—à–µ. –ü–æ—ç—Ç–æ–º—É –æ—Å—Ç–∞–≤–ª–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ –Ω–∞ –±–∞–∑–µ `python:3.6-alpine`, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Å —Ü–µ–ª—å—é —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–ª–æ–µ–≤ UnionFS –∏ —É–¥–∞–ª–µ–Ω–∏—è –ª–∏—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ–±—Ä–∞–∑–∞ (—Å–º. `src/post-py/Dockerfile`);
- –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –æ–±—Ä–∞–∑–æ–≤:
```
$ docker images

REPOSITORY       TAG       IMAGE ID       CREATED        SIZE
shrkga/ui        3.0       d04bf139a9ce   14 hours ago   92.6MB
shrkga/ui        2.0       51d523797874   15 hours ago   487MB
shrkga/ui        1.0       014be69f7086   16 hours ago   998MB
shrkga/comment   2.0       ee448af09ab0   15 hours ago   89.4MB
shrkga/comment   1.0       7523ae8028e8   16 hours ago   996MB
shrkga/post      2.0       1ea0d0e474ce   15 hours ago   69.8MB
shrkga/post      1.0       658e947326f0   16 hours ago   67.2MB
```

#### –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å volume
- –°–æ–∑–¥–∞–Ω Docker volume `reddit_db` –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å MongoDB –ø–æ –ø—É—Ç–∏ `/data/db`;
- –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã–π –ø–æ—Å—Ç –æ—Å—Ç–∞–ª—Å—è –Ω–∞ –º–µ—Å—Ç–µ;
- –§–∏–Ω–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∫–æ–º–∞–Ω–¥ —Ç–∞–∫–æ–π:
```
docker build -t shrkga/post:1.0 ./post-py
docker build -t shrkga/comment:2.0 ./comment
docker build -t shrkga/ui:3.0 ./ui

docker network create reddit

docker run -d --network=reddit --network-alias=post_db --network-alias=comment_db \
  -v reddit_db:/data/db \
  mongo:4
docker run -d --network=reddit --network-alias=post shrkga/post:1.0
docker run -d --network=reddit --network-alias=comment shrkga/comment:2.0
docker run -d --network=reddit -p 9292:9292 shrkga/ui:3.0
```

## –î–ó #13. Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã. Docker –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
–í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –î–ó.

#### –û—Å–Ω–æ–≤–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã Docker, docker-compose, docker-machine;
- –ó–∞–ø—É—â–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `hello-world`;
- –ò–∑—É—á–µ–Ω—ã –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã docker;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ docker inspect –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏ –æ–±—Ä–∞–∑–∞
- –ù–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–≤–æ–¥–∞ –∫–æ–º–∞–Ω–¥ –æ–ø–∏—Å–∞–Ω—ã –æ—Ç–ª–∏—á–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –æ—Ç –æ–±—Ä–∞–∑–∞ –≤ —Ñ–∞–π–ª–µ `/docker-monolith/docker-1.log`;

#### Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω Yandex Cloud CLI;
- –°–æ–∑–¥–∞–Ω –∏–Ω—Å—Ç–∞–Ω—Å –≤ YC;
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Docker —á–µ—Ä–µ–∑ `docker-machine`;
- –ü–æ–≤—Ç–æ—Ä–µ–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞ –∏–∑ –¥–µ–º–æ –Ω–∞ –ª–µ–∫—Ü–∏–∏;
- –°–æ–∑–¥–∞–Ω–∞ —Ç—Ä–µ–±—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è;
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ `reddit:latest`;
- –ù–∞ –∏–Ω—Å—Ç–∞–Ω—Å–µ –≤ YC –∑–∞–ø—É—â–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `reddit`;
- –ü–æ —Å—Å—ã–ª–∫–µ http://<IP_–∞–¥—Ä–µ—Å_–∏–Ω—Å—Ç–∞–Ω—Å–∞>:9292 —É—Å–ø–µ—à–Ω–æ –æ—Ç–∫—Ä—ã–ª–æ—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ;
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ Docker Hub;
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ docker –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ Docker Hub;
- –°–æ–∑–¥–∞–Ω–Ω—ã–π –æ–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ Docker Hub —Å —Ç—ç–≥–æ–º `shrkga/otus-reddit:1.0`;
- –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –¥–æ–∫–µ—Ä–µ –Ω–∞ –¥—Ä—É–≥–æ–º —Ö–æ—Å—Ç–µ;
- –í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ –î–ó;

#### –ó–∞–¥–∞–Ω–∏–µ —Å–æ ‚≠ê: –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø–æ–¥–Ω—è—Ç–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ –≤ Yandex Cloud, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ –Ω–∏—Ö –¥–æ–∫–µ—Ä–∞ –∏ –∑–∞–ø—É—Å–∫ —Ç–∞–º –æ–±—Ä–∞–∑–∞ shrkga/otus-reddit:1.0
- –ó–∞–¥–∞—á–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –≤–∏–¥–µ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/docker-monolith/infra/`;
- –°–æ–∑–¥–∞–Ω —à–∞–±–ª–æ–Ω Packer, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –æ–±—Ä–∞–∑ —Å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º Docker;
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ–∂–µ–Ω–µ—Ä `ansible`, –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–∫–µ—Ä–∞ –∏ –º–æ–¥—É–ª—è python –Ω–∞–ø–∏—Å–∞–Ω –ø–ª–µ–π–±—É–∫ `ansible/playbooks/packer_docker.yml`;
    - –î–∞–Ω–Ω—ã–π –ø–ª–µ–π–±—É–∫ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é ansible, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –Ω–µ –ø—Ä–∏ –ø–æ–º–æ—â–∏ packer;
- –ò–Ω—Å—Ç–∞–Ω—Å—ã –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é Terraform, –∏—Ö –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `docker_count`;
    - –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ –º–æ–¥—É–ª—å `terraform/modules/docker`;
- –ù–∞–ø–∏—Å–∞–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–µ–π–±—É–∫–æ–≤ Ansible —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –∏–Ω–≤–µ–Ω—Ç–æ—Ä–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–∫–µ—Ä–∞ –∏ –∑–∞–ø—É—Å–∫–∞ —Ç–∞–º –æ–±—Ä–∞–∑–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è;
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –≤ –∏–Ω—Å—Ç–∞–Ω—Å–∞—Ö –∏ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É http://<IP_–∞–¥—Ä–µ—Å_–∏–Ω—Å—Ç–∞–Ω—Å–∞>:9292
